<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  </head>
  <body>
    <a-scene>
      <a-assets>      
        <img id="wilted-plant" src="wilted-plant.png">
        <img id="healthy-plant" src="healthy-plant.png">
      </a-assets>
    
      <a-camera></a-camera>
      <a-plane color="black"></a-plane>

      <a-image id="plant" src="#wilted-plant"></a-image>
      
      <script>
        const apiUrl = 'https://raw.githubusercontent.com/hjakehamade/hhamade-honours-experience.github.io/main/.github/workflows/data.json';
        
        function fetchState() {
          fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
              const currentState = data.plant_state.health;
              if (currentState) {
                document.querySelector('#plant').setAttribute('src', '#healthy-plant');
                setTimeout(() => {
                  updateState(false);
                }, 10000); // 10 seconds
              }
            })
            .catch(error => {
              console.error('Error fetching plant state:', error);
            });
        }

        function updateState(newState) {
          const githubToken = '${{ secrets.ROOM462_KEY }}';
          fetch(apiUrl, {
            method: 'GET',
            headers: {
              'Authorization': `token ${githubToken}`
            }
          })
          .then(response => response.json())
          .then(data => {
            fetch(apiUrl, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `token ${githubToken}`
              },
              body: JSON.stringify({
                message: 'Update plant state',
                content: btoa(JSON.stringify({
                  plant_state: {
                    health: newState,
                    time_updated: new Date().toISOString()
                  }
                })),
                sha: data.sha
              })
            });
          })
          .catch(error => {
            console.error('Error updating plant state:', error);
          });
        }

        document.querySelector('#plant').addEventListener('click', () => {
          updateState(true);
          document.querySelector('#plant').setAttribute('src', '#healthy-plant');
        });

        fetchState();
      </script>
    </a-scene>          
  </body>
</html>
