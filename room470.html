<!DOCTYPE html>
<html>
  <head>

    <!--    Place the script for aframe here     -->
    <script src="aframe.min.js"></script>
    <!-- Link Clicking -->
    <script src="aframe-href-component.min.js"></script>
    <!--     Place the script for aframe extras here -->
    <script src="aframe-extras.js"></script>
    <!--     Place the script for the environment component here -->
    <script src="aframe-environment-component.min.js"></script>
    <!--    Event Waypoint Script -->
    <script src="aframe-particle-system-component.min.js"></script>  
    <script src="aframe-event-set-component.min.js"></script>
      
    <!-- ANIMATE PNG-->
    <script src="animatepng.js"></script>
      <script src="animatepng2.js"></script>
      <script src="animatepng3.js"></script>
    
    <!---VERTICAL PITCH touch controls--->
    <script>
    
    AFRAME.components["look-controls"].Component.prototype.onTouchMove = function (t) {
                        var PI_2 = Math.PI/2,
                        e,
                        o = this.el.sceneEl.canvas,
                        i = this.yawObject,
                        j = this.pitchObject;
                        this.touchStarted && this.data.touchEnabled && (e = 2 * Math.PI * (t.touches[0].pageX - this.touchStart.x) / o.clientWidth, f = 2 * Math.PI * (t.touches[0].pageY - this.touchStart.y) / o.clientHeight, j.rotation.x += .3 * f, i.rotation.y += .5 * e, j.rotation.x = Math.max(-PI_2, Math.min(PI_2, j.rotation.x)), this.touchStart = {
                                x: t.touches[0].pageX,
                                y: t.touches[0].pageY
                            })
                        }

    
    </script>
    
    
    <!--IOS VIDEO COMPATABILITY-->
    <script>
        AFRAME.registerComponent('play-on-click', {
          init: function () {
            this.onClick = this.onClick.bind(this);
          },
          play: function () {
            window.addEventListener('click', this.onClick);
          },
          pause: function () {
            window.removeEventListener('click', this.onClick);
          },
          onClick: function (evt) {
            var videoEl = this.el.getAttribute('material').src;
            if (!videoEl) { return; }
            this.el.object3D.visible = true;
            videoEl.play();
          }
        });
    </script> 
    
    
    <!--- GOTO SCRIPT --->
    <script>
      AFRAME.registerSystem("goto", {
        init: function() {
          // global - shared between all goto components
          this.isMoving = false;
        }
      });

      AFRAME.registerComponent("goto", {
        init: function() {
          let rig = document.querySelector('#pov')
          rig.addEventListener('animationcomplete', e=> {
            this.system.isMoving = false
          })
          this.el.addEventListener("click", e => {
            if (this.system.isMoving) return;
            let targetPos = this.el.getAttribute("position")
            let rigPos = rig.getAttribute("position")
            this.system.isMoving = true
            
            
            rig.setAttribute("animation", {
              "from": rigPos,
              "to": AFRAME.utils.coordinates.stringify({x: targetPos.x, y: rigPos.y, z: targetPos.z}),
              "dur": targetPos.distanceTo(rigPos) * 200
            })
            rig.emit('go')
          });
        }
      });
    </script>
    
    
    
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!---LINK TRAVERSAL-->
    <script>
    AFRAME.registerComponent('link-url', {
          schema: {url: {default: ''},},

          init: function () {
            var url = this.data.url;
            this.el.addEventListener('click', function () {
              window.location.href = url;
            });
          }
        });
    </script>

  </head>
 
  
  
   <body>
    <a-scene
             >
      <!-- Asset Management System-->

      <a-assets>
        <a-asset-item
          id="gallery"
          src="room470.gltf"
        ></a-asset-item>
        <a-asset-item
          id="gallerygeometry"
          src="room470geometry.gltf"
        ></a-asset-item>
          
          
          
        <video muted id="snail" src="Snail1.mp4" webkit-playsinline autoplay loop="true">
        </video>
        
        <a-audio id="ambient" src="https://d7d3471nr939s.cloudfront.net/VisionaryElements_Noiiz/MP3/Loops/Drones/93_F_ConfuseChrdDrone_308_01.mp3?cb=e7aec728-f30e-49f1-ad67-45ab46272b52">
        </a-audio>

        <a-asset-item
          id="soda"
          src="soda.gltf"
        ></a-asset-item>
          
        <a-asset-item
          id="sculpture2"
          src="Sculpture2.gltf"
        ></a-asset-item>
          
        <a-asset-item
          id="computer"
          src="computer.gltf"
        ></a-asset-item>

      </a-assets>
    
      <!--CAMERA-->

<a-entity 
          rotation="0 0 0">
     <a-entity position="0 0 0" 
               rotation="0 0 0" 
               id="pov" 
               animation="property: 
                          position; 
                          startEvents: go">
  <a-camera look-controls wasd-controls-enabled="true">
    <a-entity cursor="rayOrigin: mouse" 
              ></a-entity>
  </a-camera>
</a-entity>
</a-entity>
    
        
        

      <!-- Scene -->
      <a-entity gltf-model="#gallery" 
                shadow="cast: false; receive: false" 
                position="0 0 0" 
                rotation="0 -90 0"
                >
        </a-entity>
        
     <a-entity class="clickable"
          gltf-model="#gallerygeometry"
          id="Geometry"
          shadow="cast: false; receive: false" 
          position="0 0.08 0" 
          rotation="0 -90 0"
          material="opacity: 0;"
          >
        </a-entity>  
        


    <a-entity gltf-model="#soda"
              scale=".3 .3 .3"
              position=" 3 1 -4"
              animation="property: rotation;
                         to: 0 360 0;
                         loop: true;
                         easing: linear;
                         dur: 5900;"
              
              ></a-entity>
        
        
       <a-sky
               src="bsod.png"
               animate-png2></a-sky>
      
      
      
    <!--LINKS-->
	<a-text href="hallway.html" 
        position="0.2 0.81 1" 
        rotation="0 180 0" 
        color="blue"  
        scale=".5 .5 .5" 
        value="Click to Exit Room 468"
        geometry="primitive: plane; width: 2.3; height: 0.5;"
        material="color: #b7beff;"
        align=  "center"
        event-set__down="_event: mousedown; color: #ADD8E6"
            ></a-text>


        
        
        <script>
  var canClick = true; // Set initial click state to true
  var cooldownTime = 300; // Set cooldown time in milliseconds
  var isMouseDown = false; // Set initial mouse state to false
  var mouseUpEvent = new Event('mouseup'); // Create mouseup event
            
    
    document.querySelector('a-text').addEventListener('click', function () {
  if (canClick) {
    window.location.href = this.getAttribute('href');
    canClick = false; // Set click state to false
    setTimeout(function () {
      canClick = true; // Reset click state to true after cooldown
    }, cooldownTime);
  }
});

  document.querySelectorAll('.clickable').forEach(function(el) {
    el.addEventListener('mousedown', function () {
      isMouseDown = true; // Set mouse state to true when clicked down
    });

    el.addEventListener('mouseup', function (event) {
      if (isMouseDown && canClick) {
        var intersection = event.detail.intersection;
        var distance = intersection.distance;
        // Minimize accidental clicks by checking if the click was within a reasonable distance from the camera
        if (distance < 10) {
          var newPosition = intersection.point;
          newPosition.y = 1.6; // Adjust the camera height to your liking
          document.querySelector('a-camera').setAttribute('animation', 'property: position; to: ' + newPosition.x + ' ' + newPosition.y + ' ' + newPosition.z + '; dur: 500');

          canClick = false; // Set click state to false
          setTimeout(function () {
            canClick = true; // Reset click state to true after cooldown
          }, cooldownTime);
        }
      }
      isMouseDown = false; // Reset mouse state to false on click up
    });

    el.addEventListener('mouseleave', function () {
      if (isMouseDown) {
        el.dispatchEvent(mouseUpEvent); // Trigger mouseup event if mouse leaves clickable area while still clicked down
      }
      isMouseDown = false; // Reset mouse state to false on mouse leave
    });
  });
</script>
         
        
        <!-- Ambient Light -->
        <a-entity light="type: ambient;
                         color: #BBB
                         intensity: 0.2">
        </a-entity>

    </a-scene>          
  </body>
</html>